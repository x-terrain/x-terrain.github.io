const LSystemConstants={PLUS_ANGLE:"+",MINUS_ANGLE:"-",PUSH:"[",POP:"]"};LSystemConstants.STOCHASTIC_PTN=new RegExp("([.0-9]+)([a-zA-Z])"),LSystemConstants.VALID_VAR_PTN=new RegExp("[a-zA-Z]");class LSystem{constructor(t,s){this.setAngle(t.angle),this.setAxiom(t.axiom),this.rules={},this.addRules(t.rules),this.length=t.length||5,this.name=t.name||"l-system",this.iterations=t.iterations||5,this.lineWidth=t.lineWidth||4,this.gfx=s,this.bgfx,this.screenPoints=[]}init(t,s){this.gfx=createGraphics(t+2*this.lineWidth,s+2*this.lineWidth),this.bgfx=createGraphics(t+2*this.lineWidth,s+2*this.lineWidth),addScreenPositionFunction(this.gfx),this.run(this.iterations)}setAngle(t){if(!t)throw new Error("LSystem: missing angle");this.angle=t}setAxiom(t){if(!t)throw new Error("LSystem: missing axiom");this.axiom=t}addRules(t){const s={};Object.keys(t).forEach((function(e){const i=t[e];s[e]="string"==typeof i?[t[e].trim()]:t[e].map((t=>t.trim()))})),Object.assign(this.rules,s)}addRule(t,s){if(!t||!s)throw new Error("LSystem: missing rule variable/replacement");this.rules[t]=s.trim()}replace(t){const s=Object.keys(this.rules);let e,i,n=this.axiom.toString();for(let h=0;h<t;h++){e="";for(let t=0;t<n.length;t++)if(i=n[t],s.indexOf(i)>-1){const t=this.rules[i];e+=t[Math.floor(random(t.length))]}else e+=i;n=e}return n}draw(t,s,e){this.gfx.push(),this.bgfx.push(),this.gfx.translate(this.lineWidth,this.lineWidth),this.bgfx.translate(this.lineWidth,this.lineWidth);const i=new createVector(1/0,1/0),n=new createVector(-1/0,-1/0);let h=new createVector(0,0),r=0;s&&(this.gfx.translate(0-s.min.x,0-s.min.y),this.bgfx.translate(0-s.min.x,0-s.min.y));const a=Object.keys(this.rules);let o,l=new createVector(0,-this.length),g=new Array;for(let s=0;s<t.length;s++)switch(i.x=h.x<i.x?h.x:i.x,i.y=h.y<i.y?h.y:i.y,n.x=h.x>n.x?h.x:n.x,n.y=h.y>n.y?h.y:n.y,o=t[s],o){case LSystemConstants.PLUS_ANGLE:r=radians(this.angle),l.rotate(r);break;case LSystemConstants.MINUS_ANGLE:r=-radians(this.angle),l.rotate(r);break;case LSystemConstants.PUSH:g.push([h.copy(),l.copy()]);break;case LSystemConstants.POP:let[t,s]=g.pop();h=t,l=s;break;default:if(!(a.indexOf(o)>-1||o.match(LSystemConstants.VALID_VAR_PTN)))throw new Error("LSystem: Unknown token "+o);if(e){this.gfx.strokeWeight(this.lineWidth),this.gfx.stroke(colorShape),this.gfx.line(h.x,h.y,h.x+l.x,h.y+l.y);let t=[h.x,h.y,0],s=[h.x+l.x,h.y+l.y,0];this.screenPoints.push(this.gfx.screenPosition(t)),this.screenPoints.push(this.gfx.screenPosition(s))}h.add(l)}s||this.draw(t,{min:i,max:n},!0),this.gfx.pop(),this.bgfx.pop()}getString(){return this.string}run(t){this.string=this.replace(t||this.iterations),this.draw(this.string)}display(t,s){image(this.bgfx,t,s),image(this.gfx,t,s)}}